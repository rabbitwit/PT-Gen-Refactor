name: Build Worker Single File

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # 不设置缓存参数，禁用自动缓存

      - name: Generate package-lock.json if not exists
        run: |
          cd worker
          if [ ! -f package-lock.json ]; then
            echo "package-lock.json not found, generating one..."
            npm install --package-lock-only
          else
            echo "package-lock.json found"
          fi

      - name: Install dependencies
        run: |
          cd worker
          npm ci

      - name: Create dist directory
        run: |
          cd worker
          mkdir -p dist

      - name: Build single file bundle
        run: |
          cd worker
          npx rollup -c

      - name: Create clean build branch with only bundle.js
        run: |
          cd worker
          # 创建一个孤立的分支，只包含 bundle.js
          git checkout --orphan build
          git rm -rf . > /dev/null 2>&1 || echo "No files to remove"
          cp dist/bundle.js bundle.js
          git add bundle.js
          git -c user.name='github-actions[bot]' -c user.email='github-actions[bot]@users.noreply.github.com' commit -m "Auto-build: Single file bundle"
          git push -f origin build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: worker-bundle
          path: worker/bundle.js