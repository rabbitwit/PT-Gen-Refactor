name: Build Worker Single File

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate package-lock.json if not exists
        run: |
          cd worker
          if [ ! -f package-lock.json ]; then
            echo "package-lock.json not found, generating one..."
            npm install --package-lock-only
          else
            echo "package-lock.json found"
          fi

      - name: Install dependencies
        run: |
          cd worker
          npm ci

      - name: Create dist directory
        run: |
          cd worker
          mkdir -p dist

      - name: Build single file bundle
        run: |
          cd worker
          npx rollup -c

      - name: Create clean build branch with only bundle.js
        run: |
          # 先切换回主分支
          git checkout main
          # 删除远程的build分支（如果存在）
          git push origin --delete build || echo "No remote build branch to delete"
          # 创建一个孤立的build分支
          git checkout --orphan build
          # 删除所有已跟踪的文件
          git rm -rf --cached .
          # 删除工作目录中的所有文件（除了bundle.js我们稍后会添加）
          rm -rf *
          # 从worker/dist目录复制bundle.js到根目录
          cp worker/dist/bundle.js bundle.js
          # 添加bundle.js到git
          git add bundle.js
          # 提交
          git -c user.name='github-actions[bot]' -c user.email='github-actions[bot]@users.noreply.github.com' commit -m "Auto-build: Single file bundle"
          # 推送到远程
          git push -u origin build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: worker-bundle
          path: worker/dist/bundle.js